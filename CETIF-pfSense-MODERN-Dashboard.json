{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "Modern NOC dashboard with professional design - system health, network traffic, gateways, OpenVPN, IPsec, CARP and alerts with circular gauges",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "links": [],
  "panels": [
    {
      "datasource": {
        "type": "alexanderzobnin-zabbix-datasource",
        "uid": "aec2bvjiis7pca"
      },
      "fieldConfig": {
        "defaults": {
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 71,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 1,
      "options": {
        "SVGBaseFix": true,
        "add100Percentage": true,
        "calcsMutation": "standard",
        "centerAlignContent": false,
        "codeData": "{}",
        "css": "@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');*{margin:0;padding:0;box-sizing:border-box}body{background:#0b0f19;color:#e2e8f0;font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;line-height:1.6}.dashboard{min-height:100vh;padding:24px;background:linear-gradient(135deg,#0b0f19 0%,#1a1f2e 100%)}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;padding:20px 24px;background:rgba(15,23,42,0.6);backdrop-filter:blur(10px);border-radius:16px;border:1px solid rgba(100,116,139,0.2);box-shadow:0 4px 6px rgba(0,0,0,0.3)}.logo-section{display:flex;align-items:center;gap:12px}.logo-icon{width:48px;height:48px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:800;color:#fff;box-shadow:0 4px 12px rgba(59,130,246,0.4)}.logo-text{font-size:28px;font-weight:800;letter-spacing:-0.5px;background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.header-center{text-align:center;flex:1}.header-title{font-size:20px;font-weight:700;letter-spacing:1px;margin-bottom:4px;color:#f1f5f9}.header-subtitle{font-size:11px;color:#94a3b8;letter-spacing:0.5px;text-transform:uppercase}.clock-section{display:flex;flex-direction:column;align-items:flex-end}.clock{font-size:28px;font-weight:300;letter-spacing:1px;font-variant-numeric:tabular-nums;color:#f1f5f9}.clock-label{font-size:9px;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-top:2px}.main-grid{display:grid;grid-template-columns:420px 1fr;gap:24px;margin-bottom:24px}@media (max-width:1400px){.main-grid{grid-template-columns:1fr}}.card{background:rgba(15,23,42,0.6);backdrop-filter:blur(10px);border:1px solid rgba(100,116,139,0.2);border-radius:16px;padding:24px;box-shadow:0 4px 6px rgba(0,0,0,0.2)}.card-title{font-size:12px;font-weight:700;letter-spacing:2px;margin-bottom:20px;text-transform:uppercase;color:#64748b;display:flex;align-items:center;gap:8px}.card-title::before{content:'';width:3px;height:16px;background:linear-gradient(180deg,#3b82f6,#8b5cf6);border-radius:2px}.gauge-container{display:flex;justify-content:center;align-items:center;margin:20px 0}.gauge{position:relative;width:140px;height:140px}.gauge-bg{fill:none;stroke:#1e293b;stroke-width:12}.gauge-progress{fill:none;stroke-width:12;stroke-linecap:round;transition:stroke-dashoffset 0.5s ease,stroke 0.3s ease;transform:rotate(-90deg);transform-origin:50% 50%}.gauge-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}.gauge-value{font-size:32px;font-weight:700;display:block;line-height:1}.gauge-label{font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-top:4px;display:block}.status-card{background:linear-gradient(135deg,rgba(15,23,42,0.9),rgba(30,41,59,0.9));border:1px solid rgba(100,116,139,0.3);border-radius:12px;padding:16px;margin-bottom:12px;position:relative;overflow:hidden;transition:all 0.3s ease}.status-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;transition:width 0.3s ease}.status-card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.3)}.status-card.critical::before{background:linear-gradient(180deg,#ef4444,#dc2626)}.status-card.warning::before{background:linear-gradient(180deg,#f59e0b,#d97706)}.status-card.success::before{background:linear-gradient(180deg,#10b981,#059669)}.status-card.info::before{background:linear-gradient(180deg,#3b82f6,#2563eb)}.status-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.status-title{font-size:13px;font-weight:700;color:#f1f5f9;letter-spacing:0.5px}.status-badge{padding:4px 12px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;display:inline-flex;align-items:center;gap:6px}.status-badge::before{content:'';width:6px;height:6px;border-radius:50%;animation:pulse 2s infinite}.status-badge.up{background:rgba(16,185,129,0.15);color:#10b981;border:1px solid rgba(16,185,129,0.3)}.status-badge.up::before{background:#10b981}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}.status-badge.warn{background:rgba(245,158,11,0.15);color:#f59e0b;border:1px solid rgba(245,158,11,0.3)}.status-badge.warn::before{background:#f59e0b}.status-badge.down{background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}.status-badge.down::before{background:#ef4444}.metric-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}.metric-item{background:rgba(15,23,42,0.4);padding:12px;border-radius:8px;border:1px solid rgba(100,116,139,0.2)}.metric-label{font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}.metric-value{font-size:18px;font-weight:700;color:#f1f5f9;font-variant-numeric:tabular-nums}.metric-unit{font-size:11px;color:#64748b;margin-left:4px}.progress-bar{height:6px;background:rgba(15,23,42,0.6);border-radius:10px;overflow:hidden;margin-top:8px;position:relative}.progress-fill{height:100%;transition:width 0.5s ease;position:relative;border-radius:10px}.progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 2s infinite}@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}.progress-fill.cpu{background:linear-gradient(90deg,#3b82f6,#8b5cf6)}.progress-fill.memory{background:linear-gradient(90deg,#10b981,#059669)}.progress-fill.disk{background:linear-gradient(90deg,#f59e0b,#d97706)}.progress-fill.network{background:linear-gradient(90deg,#06b6d4,#0891b2)}.interface-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}.gateway-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}.vpn-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}.alert-item{background:rgba(15,23,42,0.8);border-left:4px solid;padding:12px 16px;border-radius:8px;margin-bottom:10px;display:flex;align-items:start;gap:12px;transition:all 0.3s ease}.alert-item:hover{transform:translateX(4px)}.alert-item.critical{border-color:#ef4444;background:rgba(239,68,68,0.1)}.alert-item.warning{border-color:#f59e0b;background:rgba(245,158,11,0.1)}.alert-item.info{border-color:#3b82f6;background:rgba(59,130,246,0.1)}.alert-icon{font-size:18px;margin-top:2px}.alert-content{flex:1}.alert-severity{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}.alert-message{font-size:12px;color:#e2e8f0;line-height:1.5}.traffic-indicator{display:flex;align-items:center;gap:8px;margin:8px 0}.traffic-icon{font-size:14px}.traffic-label{font-size:11px;color:#94a3b8;min-width:80px}.traffic-value{font-size:13px;font-weight:700;color:#f1f5f9;font-variant-numeric:tabular-nums}.mini-chart{height:40px;background:rgba(15,23,42,0.4);border-radius:6px;margin-top:8px;position:relative;overflow:hidden}.summary-grid{display:grid;gap:12px}.summary-item{background:rgba(15,23,42,0.5);border:1px solid rgba(100,116,139,0.2);border-radius:10px;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s ease}.summary-item:hover{background:rgba(30,41,59,0.6);border-color:rgba(100,116,139,0.4)}.summary-label{font-size:11px;color:#94a3b8;font-weight:600;letter-spacing:0.5px;text-transform:uppercase}.summary-value{font-size:20px;font-weight:700;color:#f1f5f9;font-variant-numeric:tabular-nums}.summary-value.good{color:#10b981}.summary-value.warning{color:#f59e0b}.summary-value.critical{color:#ef4444}.global-status{background:linear-gradient(135deg,rgba(15,23,42,0.9),rgba(30,41,59,0.8));border:2px solid;border-radius:12px;padding:20px;text-align:center;margin-bottom:20px;position:relative;overflow:hidden}.global-status::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}.global-status.ok{border-color:rgba(16,185,129,0.4)}.global-status.ok::before{background:linear-gradient(90deg,#10b981,#059669)}.global-status.degraded{border-color:rgba(245,158,11,0.4);animation:pulse-border 2s infinite}.global-status.degraded::before{background:linear-gradient(90deg,#f59e0b,#d97706)}.global-status.critical{border-color:rgba(239,68,68,0.4);animation:pulse-border 1s infinite}.global-status.critical::before{background:linear-gradient(90deg,#ef4444,#dc2626)}@keyframes pulse-border{0%,100%{border-color:rgba(239,68,68,0.4)}50%{border-color:rgba(239,68,68,0.8)}}.global-status-label{font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}.global-status-value{font-size:28px;font-weight:800;letter-spacing:-0.5px;margin-bottom:4px}.global-status-icon{font-size:48px;margin-bottom:12px;opacity:0.9}.scrollbar-thin::-webkit-scrollbar{width:6px;height:6px}.scrollbar-thin::-webkit-scrollbar-track{background:rgba(15,23,42,0.4)}.scrollbar-thin::-webkit-scrollbar-thumb{background:rgba(100,116,139,0.5);border-radius:3px}.scrollbar-thin::-webkit-scrollbar-thumb:hover{background:rgba(100,116,139,0.7)}",
        "dynamicData": false,
        "dynamicFieldDisplayValues": false,
        "dynamicHtmlGraphics": false,
        "dynamicProps": false,
        "fitContentToPanel": true,
        "html": "<div class=\"dashboard\"><div class=\"header\"><div class=\"logo-section\"><div class=\"logo-icon\">C</div><div class=\"logo-text\">CETIF</div></div><div class=\"header-center\"><div class=\"header-title\">pfSense Central Monitoring</div><div class=\"header-subtitle\">Real-time Network Operations Center Dashboard</div></div><div class=\"clock-section\"><div class=\"clock\" id=\"clock\">00:00:00</div><div class=\"clock-label\">Live Time</div></div></div><div class=\"main-grid\"><div><div class=\"card\"><div class=\"card-title\">System Health Overview</div><div id=\"global-status\"></div><div id=\"system-gauges\"></div></div><div class=\"card\" style=\"margin-top:24px\"><div class=\"card-title\">Critical Alerts & Warnings</div><div id=\"alerts\" class=\"scrollbar-thin\" style=\"max-height:400px;overflow-y:auto\"></div></div><div class=\"card\" style=\"margin-top:24px\"><div class=\"card-title\">Quick Status Summary</div><div class=\"summary-grid\" id=\"summary\"></div></div></div><div><div class=\"card\"><div class=\"card-title\">WAN Interfaces Status</div><div class=\"interface-grid\" id=\"wan-interfaces\"></div></div><div class=\"card\" style=\"margin-top:24px\"><div class=\"card-title\">Gateway Health Monitoring</div><div class=\"gateway-grid\" id=\"gateways\"></div></div><div class=\"card\" style=\"margin-top:24px\"><div class=\"card-title\">OpenVPN Services</div><div class=\"vpn-grid\" id=\"ovpn-servers\"></div></div><div class=\"card\" style=\"margin-top:24px\"><div class=\"card-title\">LAN / VLAN / DMZ Interfaces (Top 12 by Traffic)</div><div class=\"interface-grid\" id=\"lan-interfaces\"></div></div></div></div></div>",
        "onInit": "",
        "onInitOnResize": false,
        "onRender": "(() => { if (!htmlNode || !data || !data.series) return; const el = (q) => htmlNode.querySelector(q); const setText = (q, v) => { const n = el(q); if(n) n.innerHTML = v; }; const last = (series) => { const n = series.fields.find(f => f.type === 'number'); if (n && n.values.length) return n.values.get(n.values.length - 1); const s = series.fields.find(f => f.type === 'string'); if (s && s.values.length) return s.values.get(s.values.length - 1); return null; }; const findLastByName = (name) => { const s = data.series.find(x => x.name === name); return s ? last(s) : null; }; const toNum = (v) => (isFinite(Number(v)) ? Number(v) : 0); const bps = (v) => { const x = Number(v ?? 0); if (!isFinite(x) || x < 0) return '0 b/s'; const units = ['b/s','Kb/s','Mb/s','Gb/s','Tb/s']; let i=0, val=x; while (val >= 1024 && i < units.length-1){ val/=1024; i++; } return `${val.toFixed(val >= 100 ? 0 : val >= 10 ? 1 : 2)} ${units[i]}`; }; const formatUptime = (bootTime) => { if (!bootTime) return '--'; const now = Math.floor(Date.now() / 1000); const upSec = now - bootTime; const days = Math.floor(upSec / 86400); const hours = Math.floor((upSec % 86400) / 3600); const mins = Math.floor((upSec % 3600) / 60); if (days > 0) return `${days}d ${hours}h`; if (hours > 0) return `${hours}h ${mins}m`; return `${mins}m`; }; const formatCertDays = (unixTime) => { if (!unixTime) return null; const now = Math.floor(Date.now() / 1000); const diff = unixTime - now; const days = Math.floor(diff / 86400); return days; }; const updateClock = () => { const now = new Date(); const h = String(now.getHours()).padStart(2, '0'); const m = String(now.getMinutes()).padStart(2, '0'); const s = String(now.getSeconds()).padStart(2, '0'); setText('#clock', `${h}:${m}:${s}`); }; updateClock(); setInterval(updateClock, 1000); const createGauge = (value, label, color, criticalThreshold = 90, warningThreshold = 80) => { const radius = 54; const circumference = 2 * Math.PI * radius; const offset = circumference - (value / 100) * circumference; let strokeColor = color; if (value >= criticalThreshold) strokeColor = '#ef4444'; else if (value >= warningThreshold) strokeColor = '#f59e0b'; return `<div class=\"gauge-container\"><div class=\"gauge\"><svg viewBox=\"0 0 120 120\"><circle class=\"gauge-bg\" cx=\"60\" cy=\"60\" r=\"${radius}\"/><circle class=\"gauge-progress\" cx=\"60\" cy=\"60\" r=\"${radius}\" stroke=\"${strokeColor}\" stroke-dasharray=\"${circumference}\" stroke-dashoffset=\"${offset}\"/></svg><div class=\"gauge-text\"><span class=\"gauge-value\" style=\"color:${strokeColor}\">${value.toFixed(1)}</span><span class=\"gauge-label\">${label}</span></div></div></div>`; }; const rxRe = /^Incoming network traffic on (.+)$/i; const txRe = /^Outgoing network traffic on (.+)$/i; const rxErrRe = /^Incoming errors on (.+)$/i; const txErrRe = /^Outgoing errors on (.+)$/i; const byIf = new Map(); const ensure = (ifn) => { if (!byIf.has(ifn)) byIf.set(ifn, { rx:0, tx:0, rxErr:0, txErr:0 }); return byIf.get(ifn); }; for (const s of data.series) { const name = s.name || ''; let m; if ((m = name.match(rxRe))) ensure(m[1].trim()).rx = toNum(last(s)); else if ((m = name.match(txRe))) ensure(m[1].trim()).tx = toNum(last(s)); else if ((m = name.match(rxErrRe))) ensure(m[1].trim()).rxErr = toNum(last(s)); else if ((m = name.match(txErrRe))) ensure(m[1].trim()).txErr = toNum(last(s)); } const isWan = (n) => /^WAN($|[_-])/i.test(n); const items = [...byIf.entries()].map(([ifName, v]) => ({ ifName, ...v })); const wan = items.filter(x => isWan(x.ifName)); const lan = items.filter(x => !isWan(x.ifName)).filter(x => !x.ifName.toLowerCase().startsWith('ovpns')).sort((a,b) => (b.rx+b.tx) - (a.rx+a.tx)).slice(0, 12); const errTotal = items.reduce((acc, x) => acc + x.rxErr + x.txErr, 0); const cpuIdle = toNum(findLastByName('CPU idle time')); const cpuUsage = 100 - cpuIdle; const memAvail = toNum(findLastByName('Available memory (percent)')); const memUsage = 100 - memAvail; const diskFree = toNum(findLastByName('Free disk space on / (percentage)')); const diskUsage = 100 - diskFree; const swapFree = toNum(findLastByName('Free swap space in %')); const swapUsage = 100 - swapFree; const procTotal = toNum(findLastByName('Number of processes')); const procRun = toNum(findLastByName('Number of running processes')); const bootTime = toNum(findLastByName('Host boot time')); const uptime = formatUptime(bootTime); const mbufUsage = toNum(findLastByName('MBUF Total Used (percent)')); const newVersion = findLastByName('New Version of pfSense Available'); const certExpiry = toNum(findLastByName('Certificates Manager: earliest validTo')); const certDays = formatCertDays(certExpiry); const statesUsagePercentRaw = findLastByName('States Table Current (percent)'); const statesCurrent = toNum(findLastByName('States Table Current')); const statesMax = toNum(findLastByName('States Table Max')); let statesUsagePercent = toNum(statesUsagePercentRaw); if (statesUsagePercent <= 0 && statesCurrent > 0 && statesMax > 0) { statesUsagePercent = (statesCurrent / statesMax) * 100; } const dhcpProblems = toNum(findLastByName('DHCP Failover Pool Problems')); const carpStatus = findLastByName('CARP Status'); const carpExpected = findLastByName('Expected CARP Status'); const ipsecStatus = findLastByName('IPsec Tunnel 1 VPN CIELO  Phase 1 Status'); const ipsecEnabled = findLastByName('IPsec Tunnel 1 VPN CIELO Tunnel Enabled'); const gwNames = ['WAN', 'GW_WAN_CTI', 'defualtvl', 'extranet_ctiGW2', 'extranet_sfzGW', 'GW_DMZ', 'intranet', 'srvsintranet']; const gw = gwNames.map(name => ({ name, status: findLastByName(`Gateway ${name} Status`), loss: findLastByName(`Gateway ${name} Packet  Loss`), rtt: findLastByName(`Gateway ${name} RTT`), stddev: findLastByName(`Gateway ${name} RTT Std Deviation`) })).filter(g => g.status != null); const gwOnline = gw.filter(g => { const s = String(g.status ?? '').trim().toLowerCase(); return s.includes('up') || s.includes('online') || s.includes('ok') || s === '0' || s === '0.0'; }).length; const gwTotal = gw.length; const gwStats = gw.reduce((acc, g) => { const s = (g.status ?? '').toString(); const isUp = (() => { const clean = s.trim().toLowerCase(); return clean.includes('up') || clean.includes('online') || clean.includes('ok') || clean === '0' || clean === '0.0'; })(); const lossNum = toNum((g.loss ?? '').toString().replace('%','')); const rttNum = toNum((g.rtt ?? '').toString().replace('ms','')); const stddevNum = toNum((g.stddev ?? '').toString().replace('ms','')); if (!isUp) acc.down++; else if (rttNum > 500) acc.down++; else if (lossNum >= 2 || stddevNum > 10 || rttNum > 200) acc.warn++; return acc; }, { down: 0, warn: 0 }); const criticalSignals = [ gwStats.down > 0, statesUsagePercent > 85, swapUsage > 10, mbufUsage > 90, cpuUsage > 90, memUsage > 90, diskUsage > 90, carpStatus && carpExpected && carpStatus !== carpExpected ]; const warningSignals = [ gwStats.warn > 0, statesUsagePercent > 70, swapUsage > 5, mbufUsage > 80, cpuUsage > 80, memUsage > 80, diskUsage > 80, dhcpProblems > 0, errTotal > 100 ]; let globalClass = 'ok', globalLabel = 'All Systems Operational', globalIcon = 'âœ“', globalColor = '#10b981'; if (criticalSignals.some(Boolean)) { globalClass = 'critical'; globalLabel = 'Critical Issues Detected'; globalIcon = 'âš '; globalColor = '#ef4444'; } else if (warningSignals.some(Boolean)) { globalClass = 'degraded'; globalLabel = 'System Performance Degraded'; globalIcon = 'âš¡'; globalColor = '#f59e0b'; } const globalStatusHTML = `<div class=\"global-status ${globalClass}\"><div class=\"global-status-icon\">${globalIcon}</div><div class=\"global-status-value\" style=\"color:${globalColor}\">${globalLabel}</div><div class=\"global-status-label\">Firewall Health Status</div></div>`; setText('#global-status', globalStatusHTML); const gaugesHTML = `<div style=\"display:grid;grid-template-columns:repeat(2,1fr);gap:16px\">${createGauge(cpuUsage, 'CPU', '#3b82f6')}${createGauge(memUsage, 'Memory', '#10b981')}${createGauge(diskUsage, 'Disk', '#f59e0b')}${createGauge(statesUsagePercent, 'States', '#8b5cf6', 85, 70)}</div>`; setText('#system-gauges', gaugesHTML); const summaryHTML = `<div class=\"summary-item\"><span class=\"summary-label\">Uptime</span><span class=\"summary-value\">${uptime}</span></div><div class=\"summary-item\"><span class=\"summary-label\">WAN Interfaces</span><span class=\"summary-value\">${wan.length}</span></div><div class=\"summary-item\"><span class=\"summary-label\">Gateways Online</span><span class=\"summary-value ${gwOnline < gwTotal ? 'warning' : 'good'}\">${gwOnline} / ${gwTotal}</span></div><div class=\"summary-item\"><span class=\"summary-label\">Network Errors</span><span class=\"summary-value ${errTotal > 100 ? 'critical' : errTotal > 0 ? 'warning' : 'good'}\">${errTotal}</span></div><div class=\"summary-item\"><span class=\"summary-label\">Processes</span><span class=\"summary-value\">${procRun} / ${procTotal}</span></div><div class=\"summary-item\"><span class=\"summary-label\">MBUF Usage</span><span class=\"summary-value ${mbufUsage > 90 ? 'critical' : mbufUsage > 80 ? 'warning' : 'good'}\">${mbufUsage.toFixed(1)}%</span></div><div class=\"summary-item\"><span class=\"summary-label\">Swap Usage</span><span class=\"summary-value ${swapUsage > 10 ? 'critical' : swapUsage > 5 ? 'warning' : 'good'}\">${swapUsage.toFixed(1)}%</span></div>`; setText('#summary', summaryHTML); const mkIfCard = (x) => { const total = x.rx + x.tx; const hasTraffic = total > 0; const hasErr = (x.rxErr + x.txErr) > 0; const adminStatus = findLastByName(`Interface ${x.ifName} Admin Status`); const adminDown = adminStatus && (String(adminStatus).toLowerCase().includes('down') || String(adminStatus) === '0'); const linkStatus = findLastByName(`Interface ${x.ifName} Link Status`); const linkDown = linkStatus && (String(linkStatus).toLowerCase().includes('down') || String(linkStatus) === '0'); let status = 'up', label = 'Online', cardClass = 'success'; if (adminDown) { status = 'down'; label = 'Admin Down'; cardClass = 'critical'; } else if (linkDown) { status = 'down'; label = 'No Link'; cardClass = 'critical'; } else if (hasErr) { status = 'warn'; label = 'Errors'; cardClass = 'warning'; } else if (!hasTraffic) { status = 'up'; label = 'Idle'; cardClass = 'info'; } return `<div class=\"status-card ${cardClass}\"><div class=\"status-header\"><div class=\"status-title\">${x.ifName}</div><div class=\"status-badge ${status}\">${label}</div></div><div class=\"traffic-indicator\"><span class=\"traffic-icon\">â¬‡</span><span class=\"traffic-label\">Inbound</span><span class=\"traffic-value\">${bps(x.rx)}</span></div><div class=\"progress-bar\"><div class=\"progress-fill network\" style=\"width:${total > 0 ? Math.min((x.rx / total) * 100, 100) : 0}%\"></div></div><div class=\"traffic-indicator\"><span class=\"traffic-icon\">â¬†</span><span class=\"traffic-label\">Outbound</span><span class=\"traffic-value\">${bps(x.tx)}</span></div><div class=\"progress-bar\"><div class=\"progress-fill network\" style=\"width:${total > 0 ? Math.min((x.tx / total) * 100, 100) : 0}%\"></div></div>${hasErr ? `<div class=\"metric-item\" style=\"margin-top:12px;border:1px solid #ef4444\"><div class=\"metric-label\">Errors (In/Out)</div><div class=\"metric-value\" style=\"color:#ef4444\">${x.rxErr} / ${x.txErr}</div></div>` : ''}</div>`; }; setText('#wan-interfaces', wan.length > 0 ? wan.map(mkIfCard).join('') : '<div style=\"text-align:center;color:#64748b;padding:40px\">No WAN interfaces detected</div>'); setText('#lan-interfaces', lan.length > 0 ? lan.map(mkIfCard).join('') : '<div style=\"text-align:center;color:#64748b;padding:40px\">No LAN interfaces detected</div>'); const mkGwCard = (g) => { const s = (g.status ?? '').toString(); const isUp = (() => { const clean = s.trim().toLowerCase(); return clean.includes('up') || clean.includes('online') || clean.includes('ok') || clean === '0' || clean === '0.0'; })(); const lossNum = toNum((g.loss ?? '').toString().replace('%','')); const rttNum = toNum((g.rtt ?? '').toString().replace('ms','')); const stddevNum = toNum((g.stddev ?? '').toString().replace('ms','')); let badge = 'up', label = 'Online', cardClass = 'success'; if (!isUp) { badge='down'; label='Offline'; cardClass='critical'; } else if (rttNum > 500) { badge='down'; label='Critical Latency'; cardClass='critical'; } else if (lossNum >= 2 || stddevNum > 10 || rttNum > 200) { badge='warn'; label='Degraded'; cardClass='warning'; } const lossTxt = g.loss == null ? '--' : (typeof g.loss === 'number' ? `${g.loss.toFixed(1)}%` : String(g.loss)); const rttTxt = g.rtt == null ? '--' : (typeof g.rtt === 'number' ? `${g.rtt.toFixed(1)} ms` : String(g.rtt)); const stddevTxt = g.stddev == null ? '--' : (typeof g.stddev === 'number' ? `${g.stddev.toFixed(1)} ms` : String(g.stddev)); return `<div class=\"status-card ${cardClass}\"><div class=\"status-header\"><div class=\"status-title\">GW ${g.name}</div><div class=\"status-badge ${badge}\">${label}</div></div><div class=\"metric-grid\"><div class=\"metric-item\"><div class=\"metric-label\">Packet Loss</div><div class=\"metric-value\" style=\"color:${lossNum > 2 ? '#ef4444' : '#10b981'}\">${lossTxt}</div></div><div class=\"metric-item\"><div class=\"metric-label\">RTT</div><div class=\"metric-value\" style=\"color:${rttNum > 500 ? '#ef4444' : rttNum > 200 ? '#f59e0b' : '#10b981'}\">${rttTxt}</div></div><div class=\"metric-item\" style=\"grid-column:1/-1\"><div class=\"metric-label\">Jitter (StdDev)</div><div class=\"metric-value\" style=\"color:${stddevNum > 10 ? '#f59e0b' : '#94a3b8'}\">${stddevTxt}</div></div></div></div>`; }; setText('#gateways', gw.length > 0 ? gw.map(mkGwCard).join('') : '<div style=\"text-align:center;color:#64748b;padding:40px\">No gateways configured</div>'); const ovpnRe = /^OpenVPN Server (.+) Clients Connected$/i; const ovpnServers = []; const ovpnStatusInfo = (v) => { const s = String(v ?? '').trim().toLowerCase(); if (!s) return { level: 'down', isUp: false, label: 'Unknown' }; if (s.includes('up') || s.includes('connected') || s.includes('ok') || s.includes('listening')) return { level: 'up', isUp: true, label: 'Up' }; if (s.includes('reconnecting')) return { level: 'warn', isUp: false, label: 'Reconnecting' }; if (s.includes('waiting')) return { level: 'warn', isUp: false, label: 'Waiting' }; if (s.includes('down') || s.includes('disconnected') || s.includes('fail')) return { level: 'down', isUp: false, label: 'Down' }; const n = Number(s); if (isFinite(n)) { if (n === 0) return { level: 'down', isUp: false, label: 'Down' }; if (n === 1) return { level: 'up', isUp: true, label: 'Up' }; if (n === 2) return { level: 'warn', isUp: false, label: 'None' }; if (n === 3) return { level: 'warn', isUp: false, label: 'Reconnecting' }; if (n === 4) return { level: 'warn', isUp: false, label: 'Waiting' }; if (n === 5) return { level: 'up', isUp: true, label: 'Listening' }; return { level: n > 0 ? 'up' : 'down', isUp: n > 0, label: n > 0 ? 'Up' : 'Down' }; } return { level: 'down', isUp: false, label: 'Unknown' }; }; for (const s of data.series) { const name = s.name || ''; const m = name.match(ovpnRe); if (!m) continue; const serverName = m[1].trim(); const clients = toNum(last(s)); const statusSeries = data.series.find(x => x.name === `OpenVPN Server ${serverName} Tunnel Status`); const tunnelStatus = statusSeries ? last(statusSeries) : null; ovpnServers.push({ serverName, clients, tunnelStatus }); } ovpnServers.sort((a,b) => b.clients - a.clients); const mkOvpnCard = (o) => { const info = ovpnStatusInfo(o.tunnelStatus); let badge='down', label='Down', cardClass='critical'; if (info.level === 'warn') { badge='warn'; label=info.label; cardClass='warning'; } else if (info.isUp) { if (o.clients > 0) { badge='up'; label='Active'; cardClass='success'; } else { badge='warn'; label='Idle'; cardClass='info'; } } return `<div class=\"status-card ${cardClass}\"><div class=\"status-header\"><div class=\"status-title\">${o.serverName}</div><div class=\"status-badge ${badge}\">${label}</div></div><div style=\"text-align:center;padding:20px 0\"><div style=\"font-size:48px;font-weight:700;color:#3b82f6;line-height:1\">${o.clients}</div><div style=\"font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-top:8px\">Connected Clients</div></div><div class=\"metric-item\"><div class=\"metric-label\">Tunnel Status</div><div class=\"metric-value\" style=\"font-size:11px\">${info.label}</div></div></div>`; }; setText('#ovpn-servers', ovpnServers.length > 0 ? ovpnServers.map(mkOvpnCard).join('') : '<div style=\"text-align:center;color:#64748b;padding:40px\">No OpenVPN servers configured</div>'); const alerts = []; if (swapUsage > 10) { alerts.push({ severity: 'critical', icon: 'ðŸ”´', msg: `Swap usage critical: ${swapUsage.toFixed(1)}% - Severe memory pressure detected!` }); } else if (swapUsage > 5) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `Swap usage detected: ${swapUsage.toFixed(1)}% - Memory pressure warning` }); } if (statesUsagePercent > 85) { alerts.push({ severity: 'critical', icon: 'ðŸ”´', msg: `States table critical: ${statesUsagePercent.toFixed(1)}% - Risk of connection drops!` }); } else if (statesUsagePercent > 70) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `States table high: ${statesUsagePercent.toFixed(1)}% - Monitor closely` }); } if (mbufUsage > 90) { alerts.push({ severity: 'critical', icon: 'ðŸ”´', msg: `MBUF usage critical: ${mbufUsage.toFixed(1)}%` }); } else if (mbufUsage > 80) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `MBUF usage high: ${mbufUsage.toFixed(1)}%` }); } if (cpuUsage > 90) { alerts.push({ severity: 'critical', icon: 'ðŸ”´', msg: `CPU usage critical: ${cpuUsage.toFixed(1)}%` }); } else if (cpuUsage > 80) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `CPU usage high: ${cpuUsage.toFixed(1)}%` }); } if (memUsage > 90) { alerts.push({ severity: 'critical', icon: 'ðŸ”´', msg: `Memory usage critical: ${memUsage.toFixed(1)}%` }); } else if (memUsage > 80) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `Memory usage high: ${memUsage.toFixed(1)}%` }); } if (diskUsage > 90) { alerts.push({ severity: 'critical', icon: 'ðŸ”´', msg: `Disk usage critical: ${diskUsage.toFixed(1)}%` }); } else if (diskUsage > 80) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `Disk usage high: ${diskUsage.toFixed(1)}%` }); } if (gwStats.down > 0) { alerts.push({ severity: 'critical', icon: 'ðŸ”´', msg: `${gwStats.down} gateway(s) offline or critical latency` }); } else if (gwStats.warn > 0) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `${gwStats.warn} gateway(s) degraded performance` }); } if (errTotal > 100) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `High interface errors: ${errTotal} total errors detected` }); } if (dhcpProblems > 0) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `DHCP failover issues detected: ${dhcpProblems}` }); } if (carpStatus && carpExpected && carpStatus !== carpExpected) { alerts.push({ severity: 'critical', icon: 'ðŸ”´', msg: `CARP status mismatch: ${carpStatus} (expected: ${carpExpected})` }); } if (ipsecStatus && ipsecEnabled !== '1') { const st = String(ipsecStatus).toLowerCase(); if (!st.includes('up') && !st.includes('connected')) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `IPsec VPN CIELO: ${ipsecStatus}` }); } } if (newVersion && String(newVersion).toLowerCase() !== 'no') { alerts.push({ severity: 'info', icon: 'â„¹', msg: `pfSense update available: ${newVersion}` }); } if (certDays !== null) { if (certDays < 7) { alerts.push({ severity: 'critical', icon: 'ðŸ”´', msg: `Certificate expires in ${certDays} days!` }); } else if (certDays < 30) { alerts.push({ severity: 'warning', icon: 'âš ', msg: `Certificate expires in ${certDays} days` }); } } const alertsHTML = alerts.length === 0 ? `<div class=\"alert-item info\" style=\"border-color:#10b981\"><div class=\"alert-icon\">âœ“</div><div class=\"alert-content\"><div class=\"alert-severity\" style=\"color:#10b981\">All Clear</div><div class=\"alert-message\">No alerts or warnings detected. All systems operating normally.</div></div></div>` : alerts.map(a => `<div class=\"alert-item ${a.severity}\"><div class=\"alert-icon\">${a.icon}</div><div class=\"alert-content\"><div class=\"alert-severity\">${a.severity}</div><div class=\"alert-message\">${a.msg}</div></div></div>`).join(''); setText('#alerts', alertsHTML); })();",
        "overflow": "visible",
        "panelupdateOnMount": true,
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "renderOnMount": true,
        "rootCSS": "",
        "svgBaseFix": false,
        "useGrafanaScrollbar": false
      },
      "pluginVersion": "2.2.3",
      "targets": [
        {
          "datasource": {
            "type": "alexanderzobnin-zabbix-datasource",
            "uid": "aec2bvjiis7pca"
          },
          "group": {
            "filter": "SRVINTRANET"
          },
          "host": {
            "filter": "PFSENSE"
          },
          "item": {
            "filter": "/.*/"
          },
          "queryType": "0",
          "refId": "A",
          "resultFormat": "time_series"
        }
      ],
      "title": "CETIF â€“ pfSense Central Monitoring (Modern NOC Dashboard)",
      "type": "gapit-htmlgraphics-panel"
    }
  ],
  "preload": false,
  "refresh": "30s",
  "schemaVersion": 40,
  "tags": [
    "pfsense",
    "zabbix",
    "CETIF",
    "monitoring",
    "production",
    "noc",
    "modern",
    "professional"
  ],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-3h",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "browser",
  "title": "CETIF â€“ pfSense Modern NOC Dashboard",
  "uid": "CETIF_pfsense_modern_noc",
  "version": 1,
  "weekStart": ""
}
